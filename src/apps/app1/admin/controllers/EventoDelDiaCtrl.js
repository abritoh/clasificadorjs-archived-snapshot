angular.module("APP-CLASIFICADOR-ADMIN").controller("EventoDelDiaCtrl",["$rootScope","$scope","$location","$compile","PARAMETROS","CommonAjaxService","CommonLog","AppModelService","MediaService",function(a,i,o,n,c,d,t,e){a.currentViewName="Eventos",i.n_data={},i.Eventos=[],i.EventosInactivos=[],i.hay_mas_datos=!0,i.numeroDePagina=0,i.totalRes=0,i.hay_mas_datosInactivos=!0,i.numeroDePaginaInactivos=0,i.totalResInactivos=0,i.eventoActual={},i.loadingData=!0,i.loadingDataInactivos=!0,i.tab_active=0,i.query=void 0,i.backup_query=void 0,i.queryInactivos=void 0;var l=null,u=null;function r(a){var o=s(a.hora,":"),n=s(a.fecha,"/");i.eventoDelDia={nombre:a.nombreEvento,ubicacion:{idPais:a.idPais,idEstado:a.idEstado,idMunicipio:a.idMunicipio,idColonia:a.idColonia,idLocalidadRural:a.tipoLocalidad&&"LocalidadRural"===a.tipoLocalidad?a.idLocalidad:null,idLocalidadUrbana:a.tipoLocalidad&&"LocalidadUrbana"===a.tipoLocalidad?a.idLocalidad:null},fecha:{anio:n.c,mes:n.b,dia:n.a},hora:{hora:o.a,minuto:o.b},prioridad:{id:a.prioridad,nombre:a.prioridad.toString().toUpperCase()},asignacion:null,activo:"true"===a.activo},i.verNuevoEvento=!1,i.verEvento=!0,function(){l&&l.$destroy();v("#eventoDelDia_editar",'<div ia-evento-del-dia ng-model="eventoDelDia" ia-name="eventoDelDia_editar" mode="editar"></div>',l=i.$new())}()}function v(a,i,o){var c=n(i)(o);$(a).empty(),$(a).append(c)}function s(a,i){if(a){var o=a.split(i);return{a:o[0],b:o[1],c:o[2]}}}function b(){i.Nuevo_eventoDelDia={nombre:null,ubicacion:{idPais:"MX",idEstado:null,idMunicipio:null,idColonia:null,idLocalidadRural:null,idLocalidadUrbana:null},fecha:{anio:null,mes:null,dia:null},hora:{hora:null,minuto:null},prioridad:null,asignacion:null,activo:null},i.eventoDelDia={nombre:null,ubicacion:{idPais:null,idEstado:null,idMunicipio:null,idColonia:null,idLocalidadRural:null,idLocalidadUrbana:null},fecha:{anio:null,mes:null,dia:null},hora:{hora:null,minuto:null},prioridad:null,asignacion:null,activo:null},i.eventoActual={}}function E(a,o){0===o?(i.Eventos.splice(a,1),i.totalRes-=1):(i.EventosInactivos.splice(a,1),i.totalResInactivos-=1)}i.Nuevo_eventoDelDia={nombre:null,ubicacion:null,fecha:null,hora:null,prioridad:null,asignacion:null,activo:null},i.eventoDelDia={nombre:null,ubicacion:null,fecha:null,hora:null,prioridad:null,asignacion:null,activo:null},i.verEventoItem=function(a,o,n){angular.forEach(i.Eventos,(function(a,i){delete a.selected})),o.selected=!0,i.n_data=o,b(),i.eventoActual={idEvento:o.idEvento,item:o,index:n},r(i.n_data)},i.verEventoItemInactive=function(a,o,n){angular.forEach(i.EventosInactivos,(function(a,i){delete a.selected})),o.selected=!0,i.n_data=o,b(),i.eventoActual={idEvento:o.idEvento,item:o,index:n},r(i.n_data)},i.agregarNEvento=function(){b(),i.verEvento=!1,i.verNuevoEvento=!0,u&&u.$destroy(),v("#eventoDelDia_agregar",'<div ia-evento-del-dia ng-model="Nuevo_eventoDelDia" ia-name="eventoDelDia_agregar" mode="agregar"></div> ',u=i.$new())},i.logout=function(){o.path(c.APP1.ACTION.LOGIN)},i.$on(c.EVENTOS.bandeja_eventos,(function(a,o){i.$apply((function(){i.Eventos.unshift(o),i.totalRes+=1}))})),i.$on(c.EVENTOS.evento_del_dia_aceptar,(function(a,o){switch(o.iaName){case"eventoDelDia_agregar":i.agregarEvento(o);break;case"eventoDelDia_editar":i.editarEvento(o);break}})),i.agregarEvento=function(a){var o=i.Nuevo_eventoDelDia;if(!a.cancel){if(a.valid){var n={idEvento:"",nombreEvento:o.nombre,idPaisEvento:o.ubicacion.idPais?o.ubicacion.idPais:"",idEstadoEvento:o.ubicacion.idEstado?o.ubicacion.idEstado:"",idMunicipioEvento:o.ubicacion.idMunicipio?o.ubicacion.idMunicipio:"",idColoniaEvento:o.ubicacion.idColonia?o.ubicacion.idColonia:"",idLocalidadEvento:o.ubicacion.idLocalidadUrbana?o.ubicacion.idLocalidadUrbana:o.ubicacion.idLocalidadRural?o.ubicacion.idLocalidadRural:"",fechaEvento:o.fecha.data.fechaFMT,horaEvento:o.hora.data.horaFMT,prioridad:o.prioridad?o.prioridad.id:"",capturista:[],activo:o.activo};e.post(c.URL.agregar_evento,n,(function(a){var n,c,d;a.data.success&&(i.verNuevoEvento=!1,n=o,c=a.data.data,d={idEvento:c,nombreEvento:n.nombre,activo:n.activo.toString(),idPais:n.ubicacion.idPais,pais:n.ubicacion.data.pais.nombre,idEstado:n.ubicacion.idEstado,estado:n.ubicacion.data.estado.nombre,idMunicipio:n.ubicacion.idMunicipio,municipio:n.ubicacion.data.municipio.nombre,idLocalidad:n.ubicacion.idLocalidadUrbana?n.ubicacion.idLocalidadUrbana:n.ubicacion.idLocalidadRural?n.ubicacion.idLocalidadRural:"",localidad:n.ubicacion.idLocalidadUrbana?n.ubicacion.data.localidadUrbana.nombre:n.ubicacion.idLocalidadRural?n.ubicacion.data.localidadRural.nombre:"",tipoLocalidad:n.ubicacion.idLocalidadUrbana?"LocalidadUrbana":n.ubicacion.idLocalidadRural?"LocalidadRural":"",idColonia:n.ubicacion.idColonia,colonia:n.ubicacion.idColonia?n.ubicacion.data.colonia.nombre:"",fecha:n.fecha.data.fechaFMT,hora:n.hora.data.horaFMT,prioridad:n.prioridad.id},n.activo?(i.Eventos.unshift(d),i.totalRes+=1):(i.EventosInactivos.unshift(d),i.totalResInactivos+=1))}))}}else i.verNuevoEvento=!1,b()},i.editarEvento=function(a){var o=i.eventoDelDia;if(!a.cancel){var n={idEvento:i.eventoActual.idEvento,nombreEvento:o.nombre,idPaisEvento:o.ubicacion.idPais?o.ubicacion.idPais:"",idEstadoEvento:o.ubicacion.idEstado?o.ubicacion.idEstado:"",idMunicipioEvento:o.ubicacion.idMunicipio?o.ubicacion.idMunicipio:"",idColoniaEvento:o.ubicacion.idColonia?o.ubicacion.idColonia:"",idLocalidadEvento:o.ubicacion.idLocalidadUrbana?o.ubicacion.idLocalidadUrbana:o.ubicacion.idLocalidadRural?o.ubicacion.idLocalidadRural:"",fechaEvento:o.fecha.data.fechaFMT,horaEvento:o.hora.data.horaFMT,prioridad:o.prioridad?o.prioridad.id:"",capturista:[],activo:o.activo};e.post(c.URL.editar_evento,n,(function(a){a.data.success&&(i.verEvento=!1,function(a,o){if(i.eventoActual.item.activo===a.activo.toString())if(a.activo){i.query&&(i.backup_query=angular.copy(i.query),i.query="");var n=i.Eventos.getIndex("idEvento",i.eventoActual.idEvento);i.Eventos[n]={idEvento:a.idEvento,nombreEvento:a.nombreEvento,idPais:a.idPaisEvento,pais:o.ubicacion.idPais?o.ubicacion.data.pais.nombre:"",idEstado:a.idEstadoEvento,estado:o.ubicacion.idEstado?o.ubicacion.data.estado.nombre:"",idMunicipio:a.idMunicipioEvento,municipio:o.ubicacion.idMunicipio?o.ubicacion.data.municipio.nombre:"",idColonia:a.idColoniaEvento,colonia:o.ubicacion.idColonia?o.ubicacion.data.colonia.nombre:"",idLocalidad:a.idLocalidadEvento,localidad:o.ubicacion.idLocalidadUrbana?o.ubicacion.data.localidadUrbana.nombre:o.ubicacion.idLocalidadRural?o.ubicacion.data.localidadRural.nombre:"",tipoLocalidad:o.ubicacion.idLocalidadUrbana?"LocalidadUrbana":o.ubicacion.idLocalidadRural?"LocalidadRural":"",fecha:a.fechaEvento,hora:a.horaEvento,prioridad:a.prioridad,capturista:[],activo:a.activo.toString()},i.backup_query&&(i.query=angular.copy(i.backup_query),i.backup_query="")}else{i.queryInactivos&&(i.backup_query=angular.copy(i.queryInactivos),i.queryInactivos="");n=i.EventosInactivos.getIndex("idEvento",i.eventoActual.idEvento);i.EventosInactivos[n]={idEvento:a.idEvento,nombreEvento:a.nombreEvento,idPais:a.idPaisEvento,pais:o.ubicacion.idPais?o.ubicacion.data.pais.nombre:"",idEstado:a.idEstadoEvento,estado:o.ubicacion.idEstado?o.ubicacion.data.estado.nombre:"",idMunicipio:a.idMunicipioEvento,municipio:o.ubicacion.idMunicipio?o.ubicacion.data.municipio.nombre:"",idColonia:a.idColoniaEvento,colonia:o.ubicacion.idColonia?o.ubicacion.data.colonia.nombre:"",idLocalidad:a.idLocalidadEvento,localidad:o.ubicacion.idLocalidadUrbana?o.ubicacion.data.localidadUrbana.nombre:o.ubicacion.idLocalidadRural?o.ubicacion.data.localidadRural.nombre:"",tipoLocalidad:o.ubicacion.idLocalidadUrbana?"LocalidadUrbana":o.ubicacion.idLocalidadRural?"LocalidadRural":"",fecha:a.fechaEvento,hora:a.horaEvento,prioridad:a.prioridad,capturista:[],activo:a.activo.toString()},i.backup_query&&(i.queryInactivos=angular.copy(i.backup_query),i.backup_query="")}else if(a.activo){i.queryInactivos&&(i.backup_query=angular.copy(i.queryInactivos),i.queryInactivos=""),E(n=i.EventosInactivos.getIndex("idEvento",i.eventoActual.idEvento),1);var c={idEvento:a.idEvento,nombreEvento:a.nombreEvento,idPais:a.idPaisEvento,pais:o.ubicacion.idPais?o.ubicacion.data.pais.nombre:"",idEstado:a.idEstadoEvento,estado:o.ubicacion.idEstado?o.ubicacion.data.estado.nombre:"",idMunicipio:a.idMunicipioEvento,municipio:o.ubicacion.idMunicipio?o.ubicacion.data.municipio.nombre:"",idColonia:a.idColoniaEvento,colonia:o.ubicacion.idColonia?o.ubicacion.data.colonia.nombre:"",idLocalidad:a.idLocalidadEvento,localidad:o.ubicacion.idLocalidadUrbana?o.ubicacion.data.localidadUrbana.nombre:o.ubicacion.idLocalidadRural?o.ubicacion.data.localidadRural.nombre:"",tipoLocalidad:o.ubicacion.idLocalidadUrbana?"LocalidadUrbana":o.ubicacion.idLocalidadRural?"LocalidadRural":"",fecha:a.fechaEvento,hora:a.horaEvento,prioridad:a.prioridad,capturista:[],activo:a.activo.toString()};i.Eventos.unshift(c),i.totalRes+=1,i.backup_query&&(i.queryInactivos=angular.copy(i.backup_query),i.backup_query="")}else{i.query&&(i.backup_query=angular.copy(i.query),i.query=""),E(n=i.Eventos.getIndex("idEvento",i.eventoActual.idEvento),0);c={idEvento:a.idEvento,nombreEvento:a.nombreEvento,idPais:a.idPaisEvento,pais:o.ubicacion.idPais?o.ubicacion.data.pais.nombre:"",idEstado:a.idEstadoEvento,estado:o.ubicacion.idEstado?o.ubicacion.data.estado.nombre:"",idMunicipio:a.idMunicipioEvento,municipio:o.ubicacion.idMunicipio?o.ubicacion.data.municipio.nombre:"",idColonia:a.idColoniaEvento,colonia:o.ubicacion.idColonia?o.ubicacion.data.colonia.nombre:"",idLocalidad:a.idLocalidadEvento,localidad:o.ubicacion.idLocalidadUrbana?o.ubicacion.data.localidadUrbana.nombre:o.ubicacion.idLocalidadRural?o.ubicacion.data.localidadRural.nombre:"",tipoLocalidad:o.ubicacion.idLocalidadUrbana?"LocalidadUrbana":o.ubicacion.idLocalidadRural?"LocalidadRural":"",fecha:a.fechaEvento,hora:a.horaEvento,prioridad:a.prioridad,capturista:[],activo:a.activo.toString()};i.EventosInactivos.unshift(c),i.totalResInactivos+=1,i.backup_query&&(i.query=angular.copy(i.backup_query),i.backup_query="")}}(n,o))}))}else i.verEvento=!1,i.eventoActual={},b()},i.irClasificados=function(){o.path("clasificados")},i.loadData=function(a){if(0===a&&(i.Eventos=[],i.hay_mas_datos=!0,i.numeroDePagina=0,i.totalRes=0),i.hay_mas_datos){i.numeroDePagina++;var o={numeroDePagina:i.numeroDePagina,numeroDeResultados:c.LIST_CASE_EVENT_RESULTS_BY_PAGE,activo:!0},n=function(a){var o=a.data.data;o.length>0?(i.hay_mas_datos=!0,i.totalRes=o[0].totalRes?o[0].totalRes:o.length,i.Eventos=i.Eventos.concat(o)):i.hay_mas_datos=!1,i.loadingData=!1};"SERVICE"===c.URL.get_list_eventos.FORCE?d.post(c.URL.get_list_eventos,o).then((function(a){a.data.success?n(a):i.loadingData=!1}),(function(a){i.loadingData=!1,t.logAjaxError(a,c.URL.get_list_eventos)})):d.get(c.URL.get_list_eventos,o).then((function(a){n(a)}),(function(a){i.loadingData=!1,t.logAjaxError(a,c.URL.get_list_eventos)}))}},i.loadDataInactive=function(a){if(0===a&&(i.EventosInactivos=[],i.hay_mas_datosInactivos=!0,i.numeroDePaginaInactivos=0,i.totalResInactivos=0),i.hay_mas_datosInactivos){i.numeroDePaginaInactivos++;var o={numeroDePagina:i.numeroDePaginaInactivos,numeroDeResultados:c.LIST_CASE_EVENT_RESULTS_BY_PAGE,activo:!1},n=function(a){var o=a.data.data;o.length>0?(i.hay_mas_datosInactivos=!0,i.totalResInactivos=o[0].totalRes?o[0].totalRes:o.length,i.EventosInactivos=i.EventosInactivos.concat(o)):i.hay_mas_datosInactivos=!1,i.loadingDataInactivos=!1};"SERVICE"===c.URL.get_list_eventos.FORCE?d.post(c.URL.get_list_eventos,o).then((function(a){a.data.success?n(a):i.loadingDataInactivos=!1}),(function(a){i.loadingDataInactivos=!1,t.logAjaxError(a,c.URL.get_list_eventos)})):d.get(c.URL.get_list_eventos,o).then((function(a){n(a)}),(function(a){i.loadingDataInactivos=!1,t.logAjaxError(a,c.URL.get_list_eventos)}))}},i.loadData(0),i.loadDataInactive(0)}]);