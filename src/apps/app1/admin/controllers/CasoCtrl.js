angular.module("APP-CLASIFICADOR-ADMIN").controller("CasoCtrl",["$scope","$location","$compile","PARAMETROS","CommonAjaxService","CommonLog","AppModelService","$rootScope",function(a,o,i,s,n,c,e,t){t.currentViewName="Casos",a.n_data={},a.Casos=[],a.CasosInactivos=[],a.hay_mas_datos=!0,a.numeroDePagina=0,a.totalRes=0,a.hay_mas_datosInactivos=!0,a.numeroDePaginaInactivos=0,a.totalResInactivos=0,a.casoActual={},a.loadingData=!0,a.loadingDataInactivos=!0,a.tab_active=0,a.limitDescription=125,a.query=void 0,a.backup_query=void 0,a.queryInactivos=void 0;var r=null,u=null;function d(o){var i=C(o.fechaIniCaso,"/"),s=o.fechaFinCaso?C(o.fechaFinCaso,"/"):{a:null,b:null,c:null};a.caso={nombre:o.nombreCaso,descripcionCaso:o.descripcionCaso,fechaInicio:{anio:i.c,mes:i.b,dia:i.a},fechaFin:{anio:s.c,mes:s.b,dia:s.a},prioridad:{id:o.prioridad,nombre:o.prioridad.toString().toUpperCase()},activo:"true"===o.activo},a.verNuevoCaso=!1,a.verCaso=!0,function(){r&&r.$destroy();l("#caso_editar",'<div ia-caso ng-model="caso" ia-name="caso_editar" mode="editar"></div>',r=a.$new())}()}function l(a,o,s){var n=i(o)(s);$(a).empty(),$(a).append(n)}function C(a,o){if(a){var i=a.split(o);return{a:i[0],b:i[1],c:i[2]}}}function v(){a.Nuevo_caso={nombre:null,descripcionCaso:null,fechaInicio:{anio:null,mes:null,dia:null},fechaFin:{anio:null,mes:null,dia:null},prioridad:null,activo:null},a.caso={nombre:null,descripcionCaso:null,fechaInicio:{anio:null,mes:null,dia:null},fechaFin:{anio:null,mes:null,dia:null},prioridad:null,activo:null},a.casoActual={}}function f(o,i){0===i?(a.Casos.splice(o,1),a.totalRes-=1):(a.CasosInactivos.splice(o,1),a.totalResInactivos-=1)}a.Nuevo_caso={nombre:null,descripcionCaso:null,fechaInicio:null,fechaFin:null,prioridad:null,activo:null},a.caso={nombre:null,descripcionCaso:null,fechaInicio:null,fechaFin:null,prioridad:null,activo:null},a.descripcionLimite=function(o){var i=o;return o.length>a.limitDescription&&(i=o.slice(0,a.limitDescription)+"..."),i},a.veCasoItem=function(o,i,s){angular.forEach(a.Casos,(function(a,o){delete a.selected})),i.selected=!0,a.n_data=i,v(),a.casoActual={idCaso:i.idCaso,item:i,index:s},d(a.n_data)},a.veCasoItemInactive=function(o,i,s){angular.forEach(a.CasosInactivos,(function(a,o){delete a.selected})),i.selected=!0,a.n_data=i,v(),a.casoActual={idCaso:i.idCaso,item:i,index:s},d(a.n_data)},a.agregarNewCaso=function(){v(),a.verCaso=!1,a.verNuevoCaso=!0,u&&u.$destroy(),l("#caso_agregar",'<div ia-caso ng-model="Nuevo_caso" ia-name="caso_agregar" mode="agregar"></div> ',u=a.$new())},a.logout=function(){o.path(s.APP1.ACTION.LOGIN)},a.$on(s.EVENTOS.bandeja_casos,(function(o,i){a.$apply((function(){a.Casos.unshift(i),a.totalRes+=1}))})),a.$on(s.EVENTOS.caso_aceptar,(function(o,i){switch(i.iaName){case"caso_agregar":a.agregarCaso(i);break;case"caso_editar":a.editarCaso(i);break}})),a.agregarCaso=function(o){var i=a.Nuevo_caso;if(!o.cancel){if(o.valid){var n={idCaso:"",nombreCaso:i.nombre,descripcionCaso:i.descripcionCaso,fechaIniCaso:i.fechaInicio.data.fechaFMT,fechaFinCaso:i.fechaFin?i.fechaFin.data.fechaFMT:"",prioridad:i.prioridad?i.prioridad.id:"",activo:i.activo};e.post(s.URL.agregar_caso,n,(function(o){var s,n,c;o.data.success&&(a.verNuevoCaso=!1,s=i,n=o.data.data,c={idCaso:n,nombreCaso:s.nombre,descripcionCaso:s.descripcionCaso,activo:s.activo.toString(),fechaIniCaso:s.fechaInicio.data.fechaFMT,fechaFinCaso:s.fechaFin.data.fechaFMT,prioridad:s.prioridad.id},s.activo?(a.Casos.unshift(c),a.totalRes+=1):(a.CasosInactivos.unshift(c),a.totalResInactivos+=1))}))}}else a.verNuevoCaso=!1,v()},a.editarCaso=function(o){var i=a.caso;if(!o.cancel){var n={idCaso:a.casoActual.idCaso,nombreCaso:i.nombre,descripcionCaso:i.descripcionCaso,fechaIniCaso:i.fechaInicio.data.fechaFMT,fechaFinCaso:i.fechaFin?i.fechaFin.data.fechaFMT:"",prioridad:i.prioridad?i.prioridad.id:"",activo:i.activo};e.post(s.URL.editar_caso,n,(function(o){o.data.success&&(a.verCaso=!1,function(o){if(a.casoActual.item.activo===o.activo.toString())if(o.activo){a.query&&(a.backup_query=angular.copy(a.query),a.query="");var i=a.Casos.getIndex("idCaso",a.casoActual.idCaso);a.Casos[i]={idCaso:o.idCaso,nombreCaso:o.nombreCaso,descripcionCaso:o.descripcionCaso,fechaIniCaso:o.fechaIniCaso,fechaFinCaso:o.fechaFinCaso,prioridad:o.prioridad,activo:o.activo.toString()},a.backup_query&&(a.query=angular.copy(a.backup_query),a.backup_query="")}else{a.queryInactivos&&(a.backup_query=angular.copy(a.queryInactivos),a.queryInactivos="");i=a.CasosInactivos.getIndex("idCaso",a.casoActual.idCaso);a.CasosInactivos[i]={idCaso:o.idCaso,nombreCaso:o.nombreCaso,descripcionCaso:o.descripcionCaso,fechaIniCaso:o.fechaIniCaso,fechaFinCaso:o.fechaFinCaso,prioridad:o.prioridad,activo:o.activo.toString()},a.backup_query&&(a.queryInactivos=angular.copy(a.backup_query),a.backup_query="")}else if(o.activo){a.queryInactivos&&(a.backup_query=angular.copy(a.queryInactivos),a.queryInactivos=""),f(i=a.CasosInactivos.getIndex("idCaso",a.casoActual.idCaso),1);var s={idCaso:o.idCaso,nombreCaso:o.nombreCaso,descripcionCaso:o.descripcionCaso,fechaIniCaso:o.fechaIniCaso,fechaFinCaso:o.fechaFinCaso,prioridad:o.prioridad,activo:o.activo.toString()};a.Casos.unshift(s),a.totalRes+=1,a.backup_query&&(a.queryInactivos=angular.copy(a.backup_query),a.backup_query="")}else{a.query&&(a.backup_query=angular.copy(a.query),a.query=""),f(i=a.Casos.getIndex("idCaso",a.casoActual.idCaso),0);s={idCaso:o.idCaso,nombreCaso:o.nombreCaso,descripcionCaso:o.descripcionCaso,fechaIniCaso:o.fechaIniCaso,fechaFinCaso:o.fechaFinCaso,prioridad:o.prioridad,activo:o.activo.toString()};a.CasosInactivos.unshift(s),a.totalResInactivos+=1,a.backup_query&&(a.query=angular.copy(a.backup_query),a.backup_query="")}}(n))}))}else a.verCaso=!1,a.casoActual={},v()},a.irClasificados=function(){o.path("clasificados")},a.loadData=function(o){if(0===o&&(a.Casos=[],a.hay_mas_datos=!0,a.numeroDePagina=0,a.totalRes=0),a.hay_mas_datos){a.numeroDePagina++;var i={usuario:t.globals.infoUser.usuario,numeroDePagina:a.numeroDePagina,numeroDeResultados:s.LIST_CASE_EVENT_RESULTS_BY_PAGE,activo:!0},e=function(o){var i=o.data.data;i.length>0?(a.hay_mas_datos=!0,a.totalRes=i[0].totalRes?i[0].totalRes:i.length,a.Casos=a.Casos.concat(i)):a.hay_mas_datos=!1,a.loadingData=!1};"SERVICE"===s.URL.get_list_casos.FORCE?n.post(s.URL.get_list_casos,i).then((function(o){o.data.success?e(o):a.loadingData=!1}),(function(o){a.loadingData=!1,c.logAjaxError(o,s.URL.get_list_casos)})):n.get(s.URL.get_list_casos,i).then((function(a){e(a)}),(function(o){a.loadingData=!1,c.logAjaxError(o,s.URL.get_list_casos)}))}},a.loadDataInactive=function(o){if(0===o&&(a.CasosInactivos=[],a.hay_mas_datosInactivos=!0,a.numeroDePaginaInactivos=0,a.totalRes=0),a.hay_mas_datosInactivos){a.numeroDePaginaInactivos++;var i={usuario:t.globals.infoUser.usuario,numeroDePagina:a.numeroDePaginaInactivos,numeroDeResultados:s.LIST_CASE_EVENT_RESULTS_BY_PAGE,activo:!1},e=function(o){var i=o.data.data;i.length>0?(a.hay_mas_datosInactivos=!0,a.totalResInactivos=i[0].totalRes?i[0].totalRes:i.length,a.CasosInactivos=a.CasosInactivos.concat(i)):a.hay_mas_datosInactivos=!1,a.loadingDataInactivos=!1};"SERVICE"===s.URL.get_list_casos.FORCE?n.post(s.URL.get_list_casos,i).then((function(o){o.data.success?e(o):a.loadingDataInactivos=!1}),(function(o){a.loadingDataInactivos=!1,c.logAjaxError(o,s.URL.get_list_casos)})):n.get(s.URL.get_list_casos,i).then((function(a){e(a)}),(function(o){a.loadingDataInactivos=!1,c.logAjaxError(o,s.URL.get_list_casos)}))}},a.loadData(0),a.loadDataInactive(0)}]);